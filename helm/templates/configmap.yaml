apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mediawiki.fullname" . }}-config
  labels:
    {{- include "mediawiki.labels" . | nindent 4 }}
data:
  LocalSettings.php: |
    <?php
    # This file was automatically generated by the MediaWiki 1.39.3 installer.
    # If you make manual changes, please keep it in sync with the
    # installer input or they will be overwritten.
    #
    # See docs/Configuration.md for configuration options and examples
    # of how to modify this file.

    # For more information on configuring MediaWiki, see:
    # https://www.mediawiki.org/wiki/Manual:Configuration_settings

    # Database settings
    $wgDBtype = "{{ .Values.mediawiki.database.type }}";
    $wgDBserver = "{{ .Values.mediawiki.database.host | default (printf "%s-mysql" (include "mediawiki.fullname" .)) }}";
    $wgDBname = "{{ .Values.mediawiki.database.name }}";
    $wgDBuser = "{{ .Values.mediawiki.database.user }}";
    $wgDBpassword = file_get_contents("/var/run/secrets/{{ include "mediawiki.fullname" . }}-db-credentials/password"); # Read from mounted secret

    # Postgres specific settings
    # $wgDBport = 5432;
    # $wgDBssl = true;

    # MySQL specific settings
    $wgDBport = {{ .Values.mediawiki.database.port | default 3306 }};

    # If using a prefix for database tables
    # $wgDBprefix = "";

    # This is a randomly generated secret key. It is used by MediaWiki to
    # encrypt passwords and for other security-related operations.
    # You should not share this key with anyone.
    $wgSecretKey = "{{ .Values.mediawiki.secretKey | default (randAlphaNum 32) }}"; # Generate a random key for new installations

    # Site language code, see https://www.mediawiki.org/wiki/Manual:wiki_language
    $wgLanguageCode = "en";

    # Site name
    $wgSitename = "{{ .Values.mediawiki.siteName }}";

    # Set this to true to enable pretty URLs (e.g., /wiki/Page_title)
    # Requires web server configuration.
    $wgUsePathInfo = true;

    # The URL base path to the MediaWiki installation.
    # Example: "$wgScriptPath = \"/w\";"
    $wgScriptPath = "";

    # The URL to the MediaWiki API.
    # Example: "$wgScriptExtension = \".php\";"
    $wgScriptExtension = ".php";

    # Path to the uploads directory relative to the MediaWiki installation root.
    # Example: "$wgUploadDirectory = \"images\";"
    $wgUploadDirectory = "$wgScriptPath/images";

    # You might want to enable file uploads
    $wgEnableUploads = true;
    $wgUseImageMagick = true;
    $wgImageMagickConvertCommand = "/usr/bin/convert"; # Ensure imagemagick is installed in the container

    # Cache settings
    $wgMainCacheType = CACHE_MEMCACHED; # Or CACHE_ANYTHING
    $wgParserCacheType = CACHE_MEMCACHED;
    $wgMessageCacheType = CACHE_MEMCACHED;
    $wgMemCachedServers = [ '{{ include "mediawiki.fullname" . }}-memcached:11211' ]; # If you use memcached as a subchart

    # Debugging settings (useful for development)
    # $wgShowExceptionDetails = true;
    # $wgDebugToolbar = true;

    # ResourceLoader
    $wgResourceLoaderMaxage = [
        'default' => 3600 * 24 * 7, // 1 week
        'minor' => 3600 * 24 * 7, // 1 week
        'major' => 3600 * 24 * 7, // 1 week
    ];

    # Add more configuration as needed based on your MediaWiki requirements
    # For example, extensions:
    # wfLoadExtension( 'VisualEditor' );
    # wfLoadExtension( 'SyntaxHighlight_GeSHi' );
    # ...

    # The rest of the auto-generated LocalSettings.php content would go here.
    # It's generally good practice to keep this minimal and manage more complex
    # configuration via environment variables or a separate configuration file.
    ```